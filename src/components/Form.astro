---
export interface Props {
    slug: String;
}

const { slug } = Astro.props;
---

<div class="contactForm">
  <hr>
  <form id="comment-form" class="contactFormBox" 
    name="contact" 
    method="POST"
    data-netlify="true"
    netlify-honeypot="bot-field"
    >
    <input type="hidden" name="slug" id="slug" value={slug as string}/>
    <input type="hidden" name="form-name" value="contact"/>

    <h2>Leave a comment:</h2>
    <label><p>Name: </p><input type="text" name="name" id="name" placeholder="Name"></label>
    <label><p>Website: </p><input type="text" name="website" id="website" placeholder="(Optional) Your website"></label>
    <label><p>Email/@: </p><input type="text" name="email" id="email" placeholder="(Optional) Where can I reach you?"></label>
    <label id="hidden">Don’t fill this out if you’re human: <input name="bot-field" /></label>
    <textarea rows="4" cols="50" id="question" name="message" placeholder="Type your message here! You can use markdown and html!"></textarea>

    <div id="bottom"><button type="button" id="send">Send!</button>
    <a id="ref" href="https://sadgrl.online/learn/articles/create-webform-discord">Get your own message box!</a></div>
  </form>
</div>

<style>
    .contactFormBox {
        @apply w-full;
    }
    .contactForm {
        margin-top: 10em;
    }
    .contactForm hr {
        @apply m-0;
    }
    .contactForm label {
        @apply text-skin-base w-full;
        display: flex;
    }
    .contactForm label p {
        @apply my-2;
        width: 5rem;
    }
    #question {
        @apply w-full text-skin-base;
    }
    #question,
    #name,
    #website,
    #email {
        @apply outline-skin-base bg-skin-card px-1 w-full;
    }
    #name,
    #website,
    #email {
        @apply mb-2;
    }
    #bottom {
        @apply w-full;
        display: flex;
        justify-content: space-between;
    }
    #send {
        @apply text-skin-base bg-skin-accent hover:bg-skin-card-muted active:bg-skin-card px-2 py-1 mt-1;
        border-radius: 3px;
    }
    #ref {
        @apply mt-3;
        font-size: smaller;
    }
    #hidden {
        display: none;
    }
  </style>

<script>
    (function () {
    'use strict';

    // Centralized submit handler: send to Netlify forms and the Netlify Discord function.
    const form = document.getElementById("comment-form") as HTMLFormElement;
    const sendBtn = document.getElementById("send");

    const handleSubmit = async () => {

        //const myForm = event.target;
        const formData = new FormData(form);

        // Prepare Netlify form body (urlencoded)
        const urlEncoded = new URLSearchParams(formData as any).toString();

        try {
            // 1) Post to Netlify Forms endpoint
            const netlifyResp = await fetch("/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: urlEncoded,
            });

            // 2) Post to Discord serverless function
            const  nameInput = document.getElementById("name") as HTMLTextAreaElement;
            const webInput = document.getElementById("website") as HTMLTextAreaElement;
            const emailInput = document.getElementById("email") as HTMLTextAreaElement;
            const question = document.getElementById("question") as HTMLTextAreaElement;
            const slugInput = document.getElementById("slug") as HTMLTextAreaElement;

            const name = nameInput?.value || "(anon)";
            const slug = "New comment on: " + (slugInput?.value || "(unknown)") + "\n";
            const web = "Mail: " + (emailInput?.value || "") + "\n";
            const email = "Website: " + (webInput?.value || "") + "\n";
            const message = "Message: " + (question?.value || "");

            const date = new Date();
            const f_date = date.toLocaleDateString("sv-SE");
            const username = `${name} ${f_date}`;
            const msg = slug + email + web + message;

            const params = { username, content: msg };

            const discordResp = await fetch("/.netlify/functions/discord", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(params),
            });

            if (!netlifyResp.ok) throw new Error(`Form post failed (${netlifyResp.status})`);
            if (!discordResp.ok) throw new Error(`Discord webhook failed (${discordResp.status})`);

            alert("Thank you for your submission");

            // Clear 
            if (question) question.value = "";

        } catch (error) {
            console.error(error);
            alert("There was an error sending your message. Please try again later.");
        }
    };

    sendBtn?.addEventListener("click", handleSubmit);

})();
</script>